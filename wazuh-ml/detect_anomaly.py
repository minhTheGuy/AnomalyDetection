# detect_anomaly.py
import pandas as pd
import joblib
from sklearn.ensemble import IsolationForest
from config import CSV_PATH, MODEL_PATH
from push_alert import send_alert
from feature_engineering import engineer_all_features
from preprocessing import preprocess_dataframe
from anomaly_tuning import AnomalyFilter, analyze_anomaly_distribution
from ensemble_detector import EnsembleAnomalyDetector  # Import ensemble class

def detect():
    print("ƒêang t·∫£i m√¥ h√¨nh ƒë√£ hu·∫•n luy·ªán...")
    bundle = joblib.load(MODEL_PATH)
    
    # Check model type
    model_type = bundle.get("model_type", "single")
    
    if model_type == "ensemble":
        print("   ‚úÖ Ensemble model detected (IF + LOF + SVM)")
        detector = bundle["detector"]
        voting_threshold = bundle.get("voting_threshold", 2)
        print(f"   Voting threshold: {voting_threshold}/3")
        is_ensemble = True
    else:
        print("   ‚úÖ Single model detected (Isolation Forest)")
        detector = bundle["model"]
        is_ensemble = False
    
    encoders = bundle["encoders"]
    feature_names = bundle.get("feature_names", [])
    
    print(f"   Model trained with {len(feature_names)} features")

    # ƒê·ªçc log m·ªõi nh·∫•t
    print("ƒêang ƒë·ªçc d·ªØ li·ªáu t·ª´:", CSV_PATH)
    df = pd.read_csv(CSV_PATH)
    print(f"   Loaded {len(df)} records")

    # Feature engineering (gi·ªëng nh∆∞ khi train)
    print("Applying feature engineering...")
    df = engineer_all_features(df)

    # Preprocessing (gi·ªëng nh∆∞ khi train)
    print("Preprocessing data...")
    df, X, _ = preprocess_dataframe(df)
    
    # ƒê·∫£m b·∫£o c√≥ ƒë·ªß features nh∆∞ khi train
    print("Aligning features with training data...")
    for col in feature_names:
        if col not in X.columns:
            X[col] = 0
            print(f"   Added missing feature: {col}")
    
    # Ch·ªâ gi·ªØ features ƒë√£ train (ƒë√∫ng th·ª© t·ª±)
    X = X[feature_names]
    print(f"   Final feature matrix: {X.shape}")

    # D·ª± ƒëo√°n b·∫•t th∆∞·ªùng
    print("ƒêang d·ª± ƒëo√°n anomaly...")
    
    if is_ensemble:
        # Ensemble prediction
        predictions, votes, anomaly_votes = detector.predict(X)
        scores = detector.decision_function(X)
        
        df["anomaly_label"] = predictions
        df["anomaly_score"] = scores
        df["anomaly_votes"] = anomaly_votes
        df["iforest_vote"] = votes['iforest']
        df["lof_vote"] = votes['lof']
        df["svm_vote"] = votes['svm']
        
        # Get agreement stats
        agreement = detector.get_model_agreement(X)
    else:
        # Single model prediction
        df["anomaly_label"] = detector.predict(X)
        df["anomaly_score"] = detector.decision_function(X)

    # Apply filtering ƒë·ªÉ gi·∫£m false positives
    print("üîß Applying anomaly filters...")
    filter_engine = AnomalyFilter()
    df = filter_engine.filter_anomalies(df, remove_whitelisted=True, apply_boost=True)

    anomalies_raw = df[df["anomaly_label"] == -1]
    anomalies_filtered = df[df["anomaly_label_filtered"] == -1]
    whitelisted_count = df['is_whitelisted'].sum()
    
    print(f"\n{'='*70}")
    print(f"K·∫æT QU·∫¢ PH√ÅT HI·ªÜN")
    print(f"{'='*70}")
    print(f"T·ªïng s·ªë s·ª± ki·ªán:           {len(df)}")
    print(f"Anomalies (raw):           {len(anomalies_raw)} ({len(anomalies_raw)/len(df)*100:.2f}%)")
    print(f"Whitelisted (false +):     {whitelisted_count} ({whitelisted_count/len(df)*100:.2f}%)")
    print(f"Anomalies (filtered):      {len(anomalies_filtered)} ({len(anomalies_filtered)/len(df)*100:.2f}%)")
    print(f"Normal events:             {len(df) - len(anomalies_filtered)}")
    
    # Show ensemble-specific stats
    if is_ensemble:
        print(f"\nü§ù ENSEMBLE AGREEMENT:")
        print(f"  Unanimous (3/3):         {agreement['unanimous_anomaly']}")
        print(f"  Majority (2/3+):         {agreement['majority_anomaly']}")
        print(f"  Split (1/3):             {agreement['split_decision']}")
    
    # Analyze distribution
    analyze_anomaly_distribution(df)

    anomalies = anomalies_filtered
    if len(anomalies) > 0:
        print(f"\n{'='*70}")
        print(f"TOP 15 S·ª∞ KI·ªÜN B·∫§T TH∆Ø·ªúNG")
        print(f"{'='*70}\n")
        
        # Ch·ªçn columns ƒë·ªÉ hi·ªÉn th·ªã
        display_cols = ['timestamp', 'agent', 'rule_level', 'proto', 'src_ip', 'dst_ip', 
                        'bytes', 'event_desc', 'anomaly_score']
        
        # Add ensemble-specific columns if available
        if is_ensemble and 'anomaly_votes' in anomalies.columns:
            display_cols.append('anomaly_votes')
        
        display_cols = [c for c in display_cols if c in anomalies.columns]
        
        pd.set_option('display.max_colwidth', 60)
        
        # Show unanimous anomalies first (if ensemble)
        if is_ensemble and 'anomaly_votes' in anomalies.columns:
            unanimous = anomalies[anomalies['anomaly_votes'] == 3]
            if len(unanimous) > 0:
                print(f"üö® UNANIMOUS ANOMALIES (3/3 models agree) - {len(unanimous)} events:\n")
                top_unanimous = unanimous.nsmallest(10, "anomaly_score")
                print(top_unanimous[display_cols].to_string(index=False))
                
                if len(anomalies) > len(unanimous):
                    print(f"\nMAJORITY ANOMALIES (2/3 models agree):\n")
                    majority = anomalies[anomalies['anomaly_votes'] == 2]
                    if len(majority) > 0:
                        top_majority = majority.nsmallest(5, "anomaly_score")
                        print(top_majority[display_cols].to_string(index=False))
            else:
                # No unanimous, show top by score
                top_anomalies = anomalies.nsmallest(15, "anomaly_score")
                print(top_anomalies[display_cols].to_string(index=False))
        else:
            # Single model - show top by score
            top_anomalies = anomalies.nsmallest(15, "anomaly_score")
            print(top_anomalies[display_cols].to_string(index=False))

        # # Uncomment ƒë·ªÉ g·ª≠i c·∫£nh b√°o ng∆∞·ª£c v√†o Wazuh Dashboard
        # print("\n ƒêang g·ª≠i c·∫£nh b√°o l√™n Wazuh...")
        # for _, row in anomalies.iterrows():
        #     msg = (
        #         f"[ML Anomaly] {row.get('agent', 'unknown')} - "
        #         f"{row.get('event_desc', 'N/A')[:60]} "
        #         f"(level={row.get('rule_level', 0)}, "
        #         f"score={row.get('anomaly_score', 0):.3f})"
        #     )
        #     try:
        #         send_alert(msg)
        #     except Exception as e:
        #         print(f"    Failed to send alert: {e}")
        # print("ƒê√£ g·ª≠i t·∫•t c·∫£ c·∫£nh b√°o ML l√™n Wazuh Dashboard!")
    else:
        print("\n‚úÖ Kh√¥ng ph√°t hi·ªán s·ª± ki·ªán b·∫•t th∆∞·ªùng m·ªõi.")
    
    print(f"\n{'='*70}\n")

if __name__ == "__main__":
    detect()
